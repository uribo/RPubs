---
title: "邪智暴虐なエクセル王を倒そう"
author: "Shinya Uryu"
date: "2015年3月23日"
output: html_document
---

e-statが提供しているデータはエクセル形式です。このデータをRユーザーが使ってごにょごびょする際には、いくつかテコ入れをしてtidyなデータに作りなおす必要があります。その際、闇の深さに心が折れるとえくせるで操作し、データを作りなおすという事態に陥ってしまうので、なんとかデータの整形もRでやりたいです。

というわけで邪智暴虐なエクセルシートと格闘してみます。

今回は[RPubs - 朝食抜きすぎでは？](https://rpubs.com/yutannihilation/breakfast)で使用しているデータと同じファイルを整形してみます。元リンク同様、e-statのデータを[統計表一覧　政府統計の総合窓口- 朝食欠食率の年次推移（性・年齢階級別）](http://www.e-stat.go.jp/SG1/estat/GL08020103.do?_toGL08020103_&listID=000001118468&disp=Other&requestSender=dsearch)からダウンロード（`~/Download`ディレクトリに保存しました）

でははじめます。

```{r using_pkg, echo=TRUE}
# 使用するパッケージの読み込み
library("xlsx")
library("dplyr")
library("DT")
```

xlsファイルの読み込みには`xlsx`パッケージを使用しました。えくせるでファイルを開いて、どの行からどの行を読みこめば良いかを把握しておきます（こういう行政データは上にも下にもデータ以外の無駄な文字があったりする）。今回は8行目から23行目がデータ部分になります。

```{r}
df <- read.xlsx("~/Downloads/60-1.xlsx", sheetIndex = 1, startRow = 8, endRow = 23) # データ行を選択
names(df)
```

Rは列名のはじめに数字がくるとXをつける可愛い子ですが、今回の場合はそのせいもあって列名がカオス（データがない列もあるし）なのでなんとかします。

```{r}
df <- df[2:nrow(df), ] %>% 
  select(-1, -21, -22) # 無駄な部分を切り捨てる
colnames(df) <- c("年齢", substr(colnames(df), 6, 10)[2:19])
names(df)
```

`colnames`で列名をつけなおしているのですが、元の列名の後ろが西暦で統一されていたので、そちらを利用しました（５年ごとのデータなら`seq`でいけるなと思いきやそうでもないというワナ）。

最後に、いくつかの行に共通の値な「性別」列を付加します。

```{r}
df$性別 <- rep(c("男性", "女性"), each = 7)
df <- select(df, 性別, 年齢, 2:20) # 列の並び替え
df[, 3:20] %<>% round(3)
```

というわけで右葉曲折ありましたが、R上でデータの整形を行いました。えくせるの使用はデータの閲覧だけでおしまい！

```{r}
datatable(df)
```
